<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>KitchenCar POS</title>
        <style>
            :root { --blue:#2563eb; --muted:#666; }
            body { margin:0; font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial; background:#f5f5f5; }

            /* PC 左3:右7 */
            .container { display:flex; height:100vh; }
            .left { width:30%; max-width:30%; background:#fff; border-right:1px solid #ddd; overflow-y:auto; padding:16px; box-sizing:border-box; }
            .right { width:70%; max-width:70%; padding:16px; overflow-y:auto; box-sizing:border-box; }

            h2{margin-top:0;}
            .order-card{border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:12px; background:#fff;}
            .menu-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px;}
            .menu-item{background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; cursor:pointer; display:flex; flex-direction:column; justify-content:space-between;}
            .menu-item:hover{box-shadow:0 2px 6px rgba(0,0,0,0.08);}
            .cart-list{margin-top:16px;}
            button,input{min-height:44px; min-width:44px; font-size:16px; touch-action:manipulation;}
            .btn-main{background:var(--blue); color:white; border:none; padding:12px; border-radius:8px; width:100%;}
            .btn-sub{border:1px solid #aaa; background:white; padding:10px 12px; border-radius:8px; font-size:14px;}
            .menu-add{margin-top:20px; padding-top:16px; border-top:1px solid #ddd;}
            .menu-add input{padding:10px; border-radius:8px; border:1px solid #ccc;}
            .small{font-size:12px; color:var(--muted);}
            .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:1000;}
            .modal{background:#fff; padding:20px; border-radius:12px; width:min(420px,90%); box-shadow:0 8px 30px rgba(0,0,0,0.2);}
            .flex{display:flex;}
            .space-x-2>*+*{margin-left:8px;}
            .hidden{display:none !important; pointer-events:none !important;}
            .editor label{display:block; margin-top:8px; font-size:13px;}
            .editor input{width:100%; box-sizing:border-box;}
            .muted{color:var(--muted); font-size:13px;}

            /* スマホ対応 */
            @media screen and (max-width:768px){
            .container{flex-direction:column; height:auto;}
            .left,.right{width:100% !important; max-width:100% !important; border-right:none; height:auto;}
            .menu-grid{grid-template-columns:repeat(2,1fr);}
            .menu-add>div{flex-direction:column;}
            .menu-add input,.menu-add button{width:100%; margin-bottom:8px;}
            }
            
            @media screen and (max-width:480px){ .menu-grid{grid-template-columns:repeat(1,1fr);} }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="left">
                <h2>注文キュー</h2>
                <div id="orders"></div>
            </div>
            <div class="right">
                <h2>メニュー</h2>
                <div class="menu-grid" id="menu" aria-live="polite"></div>
                <div class="cart-list">
                    <h3>現在のカート</h3>
                    <div id="cart">商品がありません</div>
                    <div style="margin-top:12px" class="flex space-x-2">
                        <button class="btn-main" id="placeOrderBtn">注文を確定</button>
                        <button class="btn-sub" id="clearCartBtn">カートをクリア</button>
                    </div>
                </div>
                <div class="menu-add">
                    <h3>メニュー管理</h3>
                    <div style="display:flex; gap:8px; margin-top:8px">
                        <input id="newName" placeholder="名前" />
                        <input id="newPrice" placeholder="価格" type="number" />
                        <button class="btn-sub" id="addMenuBtn">追加</button>
                    </div>
                    <div class="small" style="margin-top:8px">メニューは localStorage に保存されます。別端末で共有したい場合は Supabase 等に差し替えます。</div>
                </div>
            </div>
        </div>

        <!-- 数量モーダル -->
        <div id="qtyModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
            <div class="modal" role="document">
                <div id="modalTitle" style="font-weight:600; margin-bottom:8px">商品名</div>
                <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:12px">
                    <button class="btn-sub" id="modalMinus">-</button>
                    <div id="modalQty" style="font-size:20px; width:40px; text-align:center">1</div>
                    <button class="btn-sub" id="modalPlus">+</button>
                </div>
                <div style="display:flex; gap:8px">
                    <button class="btn-main" id="modalAdd">カートに追加</button>
                    <button class="btn-sub" id="modalCancel">キャンセル</button>
                </div>
            </div>
        </div>

        <!-- 編集モーダル -->
        <div id="editModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
            <div class="modal editor" role="document">
                <h3 id="editTitle">メニュー編集</h3>
                <label for="editName">商品名</label>
                <input id="editName" />
                <label for="editPrice">価格</label>
                <input id="editPrice" type="number" />
                <div style="display:flex; gap:8px; margin-top:12px">
                    <button class="btn-main" id="editSave">保存</button>
                    <button class="btn-sub" id="editCancel">閉じる</button>
                </div>
            </div>
        </div>

        <script>
            // --- データ管理 ---
            const LS_MENU='kc_menu_v1', LS_ORDERS='kc_orders_v1';
            let menu=JSON.parse(localStorage.getItem(LS_MENU))||[{id:1,name:'カレーライス',price:700},{id:2,name:'唐揚げ弁当',price:650},{id:3,name:'コーラ',price:200}];
            let orders=JSON.parse(localStorage.getItem(LS_ORDERS))||[];
            let cart=[], modalIndex=null, modalQty=1, editingIndex=null;

            function saveMenu(){ localStorage.setItem(LS_MENU, JSON.stringify(menu)) }
            function saveOrders(){ localStorage.setItem(LS_ORDERS, JSON.stringify(orders)) }
            function $(id){ return document.getElementById(id) }
            function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
            function showModal(m){ m.classList.remove('hidden'); m.style.display='flex'; m.style.pointerEvents='auto'; }
            function hideModal(m){ m.classList.add('hidden'); m.style.display='none'; m.style.pointerEvents='none'; }

            // --- レンダリング ---
            function renderMenu(){
                const area=$('menu'); area.innerHTML='';
                menu.forEach((item,idx)=>{
                    const card=document.createElement('div'); card.className='menu-item';
                    const info=document.createElement('div');
                    const name=document.createElement('div'); name.style.fontWeight='600'; name.textContent=item.name;
                    const price=document.createElement('div'); price.className='small'; price.textContent=`¥${item.price}`;
                    info.appendChild(name); info.appendChild(price);
                    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
                    ['選択','編集','削除'].forEach(text=>{
                        const btn=document.createElement('button'); btn.className='btn-sub'; btn.textContent=text;
                        btn.dataset.idx=idx; btn.dataset.action=text==='選択'?'select':text==='編集'?'edit':'delete';
                        ['click','touchstart'].forEach(ev=> btn.addEventListener(ev,e=>{
                            e.stopPropagation();
                            if(btn.dataset.action==='select') openQtyModal(idx);
                            else if(btn.dataset.action==='edit') openEditModal(idx);
                            else handleRemove(idx);
                        }));
                        actions.appendChild(btn);
                    });
                    card.appendChild(info); card.appendChild(actions); area.appendChild(card);
                });
            }

            function renderCart(){ const area=$('cart'); area.innerHTML = cart.length? cart.map(c=>`${escapeHtml(c.name)} x${c.qty} = ¥${c.price*c.qty}`).join('<br>'):'商品がありません'; }

            function renderOrders(){ const area=$('orders'); area.innerHTML=''; 
                if(!orders.length){ area.innerHTML='<div class="small">注文はありません</div>'; return }
                orders.forEach(o=>{
                    const div=document.createElement('div'); div.className='order-card';
                    const items=o.items.map(i=>`${escapeHtml(i.name)} x${i.qty}`).join('<br>');
                    div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:start"><div><div style="font-weight:600">注文 #${String(o.id).slice(-4)}</div><div class="small">${new Date(o.createdAt).toLocaleTimeString()}</div></div><div style="font-weight:600">¥${o.total}</div></div><div style="margin-top:8px">${items}</div>`;
                    const btnWrap=document.createElement('div'); btnWrap.style.display='flex'; btnWrap.style.gap='8px'; btnWrap.style.marginTop='8px';
                    const toggle=document.createElement('button'); toggle.className='btn-sub'; toggle.textContent=o.status==='open'?'完了にする':'未完了に戻す';
                    ['click','touchstart'].forEach(ev=> toggle.addEventListener(ev, ()=>{ o.status=o.status==='open'?'done':'open'; saveOrders(); renderOrders() }));
                    const del=document.createElement('button'); del.className='btn-sub'; del.textContent='削除';
                    ['click','touchstart'].forEach(ev=> del.addEventListener(ev, ()=>{ if(confirm('注文を削除しますか？')){ orders=orders.filter(x=>x.id!==o.id); saveOrders(); renderOrders() } }));
                    btnWrap.appendChild(toggle); btnWrap.appendChild(del); div.appendChild(btnWrap); area.appendChild(div);
                });
            }

            // --- メニュー操作 ---
            function addMenu(){
                const name=$('newName').value.trim();
                const price=parseFloat($('newPrice').value);
                if(!name) return alert('名前を入力してください');
                if(isNaN(price)||price<=0) return alert('価格を正しく入力してください');
                const id=Date.now();
                menu.push({id,name,price}); saveMenu(); renderMenu(); $('newName').value=''; $('newPrice').value='';
            }

            function handleRemove(idx){ if(!confirm('本当に削除しますか？')) return; if(idx<0||idx>=menu.length){ alert('削除対象のメニューが見つかりません'); return } menu.splice(idx,1); saveMenu(); renderMenu(); }
            function openEditModal(idx){ editingIndex=idx; $('editName').value=menu[idx].name; $('editPrice').value=menu[idx].price; showModal($('editModal')) }
            $('editSave').addEventListener('click', ()=>{ if(editingIndex===null) return; const n=$('editName').value.trim(); const p=parseFloat($('editPrice').value); if(!n) return alert('名前を入力してください'); if(isNaN(p)||p<=0) return alert('価格を正しく入力してください'); menu[editingIndex].name=n; menu[editingIndex].price=p; saveMenu(); renderMenu(); editingIndex=null; hideModal($('editModal')) });
            $('editCancel').addEventListener('click', ()=>{ editingIndex=null; hideModal($('editModal')) });

            // --- 数量モーダル ---
            $('modalMinus').addEventListener('click', ()=>changeModalQty(-1));
            $('modalPlus').addEventListener('click', ()=>changeModalQty(1));
            $('modalAdd').addEventListener('click', ()=>confirmModalAdd());
            $('modalCancel').addEventListener('click', ()=>hideModal($('qtyModal')));
            function openQtyModal(idx){ modalIndex=idx; modalQty=1; $('modalTitle').textContent=menu[idx].name; $('modalQty').textContent=modalQty; showModal($('qtyModal')) }
            function changeModalQty(n){ modalQty=Math.max(1,modalQty+n); $('modalQty').textContent=modalQty }
            function confirmModalAdd(){ if(modalIndex===null) return; const item=menu[modalIndex]; const found=cart.find(c=>c.id===item.id); if(found) found.qty+=modalQty; else cart.push({id:item.id,name:item.name,price:item.price,qty:modalQty}); renderCart(); hideModal($('qtyModal')) }

            // --- カート操作 ---
            ['clearCartBtn','placeOrderBtn','addMenuBtn'].forEach(id=>{
                const el=$(id); 
                if(el) ['click','touchstart'].forEach(ev=> el.addEventListener(ev, e=>{
                    e.preventDefault();
                    if(id==='clearCartBtn'){ cart=[]; renderCart(); }
                    if(id==='placeOrderBtn'){ 
                        if(!cart.length){ alert('カートに商品がありません'); return }
                        const order={id:Date.now(), items:JSON.parse(JSON.stringify(cart)), total:cart.reduce((s,i)=>s+i.price*i.qty,0), createdAt:new Date().toISOString(), status:'open'};
                        orders.unshift(order); cart=[]; saveOrders(); renderOrders(); renderCart();
                    }
                    if(id==='addMenuBtn'){ addMenu(); }
                }));
            });

            // --- 初期レンダリング ---
            renderMenu(); renderCart(); renderOrders();
        </script>
    </body>
</html>
